echo off
cls
cd %~dp0
SET app=db4045
SET AppVersionFile=ScaleAPI\AppVersion.cs
REM ***********************************************************************************************************
REM ***********************************************************************************************************
REM ****** Next part will filter the version from our AppVersion file
REM ***********************************************************************************************************
REM ***********************************************************************************************************
SET version=0.0.0.0
FOR /F "eol=; tokens=9 delims=, " %%i in ('findstr /C:"string Version" %AppVersionFile%') do (set version=%%i)
SET version=%version:"=%
SET version=%version:;=%
REM ECHO %version% %AppVersionFile%
REM SET /p DUMMY=Hit ENTER to continue...

REM ***********************************************************************************************************
REM ***********************************************************************************************************
REM ****** Next part will Get the Git revision of this project
REM ***********************************************************************************************************
REM ***********************************************************************************************************
git tag -a v%version% -m "Version "%version%
FOR /F "tokens=* USEBACKQ" %%F IN (`git rev-parse --short HEAD`) DO (
  SET hash=%%F
)
REM ***********************************************************************************************************
REM ***********************************************************************************************************
REM ****** Next part will create the apptag 
REM ***********************************************************************************************************
REM ***********************************************************************************************************
SET appTag=v%version%-%hash%

REM ***********************************************************************************************************
REM ***********************************************************************************************************
REM ****** Next part will Build the image for our app
REM ***********************************************************************************************************
REM ***********************************************************************************************************
ECHO Start building %app%:%appTag%
ECHO Version: %version%
docker image build --pull -t %app%:%appTag% .
ECHO Start saving %app% %appTag%
docker save %app%:%appTag% -o %app%.%appTag%.tar 
SET /p DUMMY=Hit ENTER to continue...